name: MLOps Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  API_SERVICE_NAME: wine-quality-api
  FRONTEND_SERVICE_NAME: wine-quality-frontend

jobs:
  train-and-register:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Train model and log to W&B
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        run: |
          python src/train.py --project_name wine-quality-mlops --n_estimators 100 --max_depth 10

      - name: Upload model artifact
        uses: actions/upload-artifact@v3
        with:
          name: trained-model
          path: models/

  test:
    runs-on: ubuntu-latest
    needs: train-and-register
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Download model artifact
        uses: actions/download-artifact@v3
        with:
          name: trained-model
          path: models/

      - name: Run tests
        run: |
          pytest tests/ -v

  deploy-api:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download model artifact
        uses: actions/download-artifact@v3
        with:
          name: trained-model
          path: models/

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker

      - name: Build and push API image
        run: |
          docker build -f Dockerfile.api -t gcr.io/$PROJECT_ID/$API_SERVICE_NAME:${{ github.sha }} .
          docker push gcr.io/$PROJECT_ID/$API_SERVICE_NAME:${{ github.sha }}

      - name: Deploy API to Cloud Run
        run: |
          gcloud run deploy $API_SERVICE_NAME \
            --image gcr.io/$PROJECT_ID/$API_SERVICE_NAME:${{ github.sha }} \
            --platform managed \
            --region $REGION \
            --allow-unauthenticated \
            --set-env-vars WANDB_API_KEY=${{ secrets.WANDB_API_KEY }}

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-api
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Get API URL
        id: get-api-url
        run: |
          API_URL=$(gcloud run services describe $API_SERVICE_NAME --region $REGION --format 'value(status.url)')
          echo "API_URL=$API_URL" >> $GITHUB_OUTPUT

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker

      - name: Build and push Frontend image
        run: |
          docker build -f Dockerfile.frontend -t gcr.io/$PROJECT_ID/$FRONTEND_SERVICE_NAME:${{ github.sha }} .
          docker push gcr.io/$PROJECT_ID/$FRONTEND_SERVICE_NAME:${{ github.sha }}

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy $FRONTEND_SERVICE_NAME \
            --image gcr.io/$PROJECT_ID/$FRONTEND_SERVICE_NAME:${{ github.sha }} \
            --platform managed \
            --region $REGION \
            --allow-unauthenticated \
            --set-env-vars API_URL=${{ steps.get-api-url.outputs.API_URL }}
